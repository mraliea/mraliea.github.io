<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="zhengliang"><title>全文搜索引擎 Elasticsearch 基础教程 · aliea个人博客</title><meta name="description" content="全文搜索引擎 Elasticsearch 基础教程"><meta name="keywords" content="aliea个人博客,Java,HTML,CSS,JavaSrcipt,android,Linux"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">aliea个人博客</a></h3><div class="description"><p>点滴记录 , 积少成多 .</p></div></div></div><ul class="social-links"><li><a href="https://twitter.com/mraliea"><i class="fa fa-twitter"></i></a></li><li><a href="http://weibo.com/mraliea"><i class="fa fa-weibo"></i></a></li><li><a href="http://facebook.com/mraliea"><i class="fa fa-facebook"></i></a></li><li><a href="http://github.com/mraliea"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Designed by </span></a><a href="https://mraliea.github.io"> Zhengliang </a><div class="by_farbox"><a href="https://mraliea.github.io" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/tags">标签</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img src="/images/favicon.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>全文搜索引擎 Elasticsearch 基础教程</a></h3></div><div class="post-content"><p>全文搜索属于最常见的需求，开源的 Elasticsearch （以下简称 Elastic）是目前全文搜索引擎的首选。</p>
<p>它可以快速地储存、搜索和分析海量数据。维基百科、Stack Overflow、Github 都采用它。</p>
<p><img src="https://mraliea.github.io/images/content/java4-01.jpg" alt="java4-01"></p>
<p>Elastic 的底层是开源库 Lucene。但是，你没法直接用 Lucene，必须自己写代码去调用它的接口。Elastic 是 Lucene 的封装，提供了 REST API 的操作接口，开箱即用。</p>
<p>本文从零开始，讲解如何使用 Elastic 搭建自己的全文搜索引擎。每一步都有详细的说明，大家跟着做就能学会。</p>
<h5 id="一、安装"><a href="#一、安装" class="headerlink" title="一、安装"></a>一、安装</h5><p>Elastic 需要 Java 8 环境。如果你的机器还没安装 Java，可以参考这篇文章，注意要保证环境变量JAVA_HOME正确设置。</p>
<p>安装完 Java，就可以跟着官方文档安装 Elastic。直接下载压缩包比较简单。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.5.1.zip</div><div class="line">$ unzip elasticsearch-5.5.1.zip</div><div class="line">$ <span class="built_in">cd</span> elasticsearch-5.5.1/</div></pre></td></tr></table></figure>
<p>接着，进入解压后的目录，运行下面的命令，启动 Elastic。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ./bin/elasticsearch</div></pre></td></tr></table></figure></p>
<p>如果这时报错”<font color="#FF69B4">max virtual memory areas vm.max<em>map</em>count [65530] is too low</font>“，要运行下面的命令。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo sysctl -w vm.max_map_count=262144</div></pre></td></tr></table></figure></p>
<p>如果一切正常，Elastic 就会在默认的9200端口运行。这时，打开另一个命令行窗口，请求该端口，会得到说明信息。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ curl localhost:9200</div></pre></td></tr></table></figure></p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"name"</span> : <span class="string">"atntrTf"</span>,</div><div class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elasticsearch"</span>,</div><div class="line">  <span class="string">"cluster_uuid"</span> : <span class="string">"tf9250XhQ6ee4h7YI11anA"</span>,</div><div class="line">  <span class="string">"version"</span> : &#123;</div><div class="line">    <span class="string">"number"</span> : <span class="string">"5.5.1"</span>,</div><div class="line">    <span class="string">"build_hash"</span> : <span class="string">"19c13d0"</span>,</div><div class="line">    <span class="string">"build_date"</span> : <span class="string">"2017-07-18T20:44:24.823Z"</span>,</div><div class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</div><div class="line">    <span class="string">"lucene_version"</span> : <span class="string">"6.6.0"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面代码中，请求9200端口，Elastic 返回一个 JSON 对象，包含当前节点、集群、版本等信息。</p>
<p>按下 Ctrl + C，Elastic 就会停止运行。</p>
<p>默认情况下，Elastic 只允许本机访问，如果需要远程访问，可以修改 Elastic 安装目录的config/elasticsearch.yml文件，去掉network.host的注释，将它的值改成0.0.0.0，然后重新启动 Elastic。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">network.host: 0.0.0.0</div></pre></td></tr></table></figure></p>
<p>上面代码中，设成0.0.0.0让任何人都可以访问。线上服务不要这样设置，要设成具体的 IP。</p>
<h5 id="二、基本概念"><a href="#二、基本概念" class="headerlink" title="二、基本概念"></a>二、基本概念</h5><h6 id="2-1-Node-与-Cluster"><a href="#2-1-Node-与-Cluster" class="headerlink" title="2.1 Node 与 Cluster"></a>2.1 Node 与 Cluster</h6><p>Elastic 本质上是一个分布式数据库，允许多台服务器协同工作，每台服务器可以运行多个 Elastic 实例。</p>
<p>单个 Elastic 实例称为一个节点（node）。一组节点构成一个集群（cluster）。</p>
<h6 id="2-2-Index"><a href="#2-2-Index" class="headerlink" title="2.2 Index"></a>2.2 Index</h6><p>Elastic 会索引所有字段，经过处理后写入一个反向索引（Inverted Index）。查找数据的时候，直接查找该索引。</p>
<p>所以，Elastic 数据管理的顶层单位就叫做 Index（索引）。它是单个数据库的同义词。每个 Index （即数据库）的名字必须是小写。</p>
<p>下面的命令可以查看当前节点的所有 Index。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ curl -X GET <span class="string">'[http://localhost](http://localhost/):9200/_cat/indices?v'</span></div></pre></td></tr></table></figure></p>
<h6 id="2-3-Document"><a href="#2-3-Document" class="headerlink" title="2.3 Document"></a>2.3 Document</h6><p>Index 里面单条的记录称为 Document（文档）。许多条 Document 构成了一个 Index。</p>
<p>Document 使用 JSON 格式表示，下面是一个例子。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"user"</span>: <span class="string">"张三"</span>,</div><div class="line">  <span class="string">"title"</span>: <span class="string">"工程师"</span>,</div><div class="line">  <span class="string">"desc"</span>: <span class="string">"数据库管理"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>同一个 Index 里面的 Document，不要求有相同的结构（scheme），但是最好保持相同，这样有利于提高搜索效率。</p>
<h6 id="2-4-Type"><a href="#2-4-Type" class="headerlink" title="2.4 Type"></a>2.4 Type</h6><p>Document 可以分组，比如weather这个 Index 里面，可以按城市分组（北京和上海），也可以按气候分组（晴天和雨天）。这种分组就叫做 Type，它是虚拟的逻辑分组，用来过滤 Document。</p>
<p>不同的 Type 应该有相似的结构（schema），举例来说，id字段不能在这个组是字符串，在另一个组是数值。这是与关系型数据库的表的一个区别。性质完全不同的数据（比如products和logs）应该存成两个 Index，而不是一个 Index 里面的两个 Type（虽然可以做到）。</p>
<p>下面的命令可以列出每个 Index 所包含的 Type。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ curl <span class="string">'localhost:9200/_mapping?pretty=true'</span></div></pre></td></tr></table></figure></p>
<p>根据规划，Elastic 6.x 版只允许每个 Index 包含一个 Type，7.x 版将会彻底移除 Type。</p>
<h5 id="三、新建和删除-Index"><a href="#三、新建和删除-Index" class="headerlink" title="三、新建和删除 Index"></a>三、新建和删除 Index</h5><p>新建 Index，可以直接向 Elastic 服务器发出 PUT 请求。下面的例子是新建一个名叫weather的 Index。</p>
<p> $ curl -X PUT ‘localhost:9200/weather’<br>服务器返回一个 JSON 对象，里面的acknowledged字段表示操作成功。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"acknowledged"</span>:<span class="literal">true</span>,</div><div class="line">  <span class="string">"shards_acknowledged"</span>:<span class="literal">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后，我们发出 DELETE 请求，删除这个 Index。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ curl -X DELETE <span class="string">'localhost:9200/weather'</span></div></pre></td></tr></table></figure></p>
<h5 id="四、中文分词设置"><a href="#四、中文分词设置" class="headerlink" title="四、中文分词设置"></a>四、中文分词设置</h5><p>首先，安装中文分词插件。这里使用的是 ik，也可以考虑其他插件（比如 smartcn）。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ./bin/elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v5.5.1/elasticsearch-analysis-ik-5.5.1.zip</div></pre></td></tr></table></figure></p>
<p>上面代码安装的是5.5.1版的插件，与 Elastic 5.5.1 配合使用。</p>
<p>接着，重新启动 Elastic，就会自动加载这个新安装的插件。</p>
<p>然后，新建一个 Index，指定需要分词的字段。这一步根据数据结构而异，下面的命令只针对本文。基本上，凡是需要搜索的中文字段，都要单独设置一下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">$ curl -X PUT <span class="string">'localhost:9200/accounts'</span> -d <span class="string">'</span></div><div class="line"><span class="string">&#123;</span></div><div class="line"><span class="string">  "mappings": &#123;</span></div><div class="line"><span class="string">    "person": &#123;</span></div><div class="line"><span class="string">      "properties": &#123;</span></div><div class="line"><span class="string">        "user": &#123;</span></div><div class="line"><span class="string">          "type": "text",</span></div><div class="line"><span class="string">          "analyzer": "ik_max_word",</span></div><div class="line"><span class="string">          "search_analyzer": "ik_max_word"</span></div><div class="line"><span class="string">        &#125;,</span></div><div class="line"><span class="string">        "title": &#123;</span></div><div class="line"><span class="string">          "type": "text",</span></div><div class="line"><span class="string">          "analyzer": "ik_max_word",</span></div><div class="line"><span class="string">          "search_analyzer": "ik_max_word"</span></div><div class="line"><span class="string">        &#125;,</span></div><div class="line"><span class="string">        "desc": &#123;</span></div><div class="line"><span class="string">          "type": "text",</span></div><div class="line"><span class="string">          "analyzer": "ik_max_word",</span></div><div class="line"><span class="string">          "search_analyzer": "ik_max_word"</span></div><div class="line"><span class="string">        &#125;</span></div><div class="line"><span class="string">      &#125;</span></div><div class="line"><span class="string">    &#125;</span></div><div class="line"><span class="string">  &#125;</span></div><div class="line"><span class="string">&#125;'</span></div></pre></td></tr></table></figure>
<p>上面代码中，首先新建一个名称为accounts的 Index，里面有一个名称为person的 Type。person有三个字段。</p>
<ul>
<li><strong>user</strong></li>
<li><strong>title</strong></li>
<li><strong>desc</strong><br>这三个字段都是中文，而且类型都是文本（text），所以需要指定中文分词器，不能使用默认的英文分词器。</li>
</ul>
<p>Elastic 的分词器称为 analyzer。我们对每个字段指定分词器。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="string">"user"</span>: &#123;</div><div class="line">  <span class="string">"type"</span>: <span class="string">"text"</span>,</div><div class="line">  <span class="string">"analyzer"</span>: <span class="string">"ik_max_word"</span>,</div><div class="line">  <span class="string">"search_analyzer"</span>: <span class="string">"ik_max_word"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面代码中，analyzer是字段文本的分词器，search_analyzer是搜索词的分词器。ik_max_word分词器是插件ik提供的，可以对文本进行最大数量的分词。</p>
<h5 id="五、数据操作"><a href="#五、数据操作" class="headerlink" title="五、数据操作"></a>五、数据操作</h5><h6 id="5-1-新增记录"><a href="#5-1-新增记录" class="headerlink" title="5.1 新增记录"></a>5.1 新增记录</h6><p>向指定的 /Index/Type 发送 PUT 请求，就可以在 Index 里面新增一条记录。比如，向/accounts/person发送请求，就可以新增一条人员记录。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ curl -X PUT <span class="string">'localhost:9200/accounts/person/1'</span> -d <span class="string">'</span></div><div class="line"><span class="string">&#123;</span></div><div class="line"><span class="string">  "user": "张三",</span></div><div class="line"><span class="string">  "title": "工程师",</span></div><div class="line"><span class="string">  "desc": "数据库管理"</span></div><div class="line"><span class="string">&#125;'</span></div></pre></td></tr></table></figure>
<p>服务器返回的 JSON 对象，会给出 Index、Type、Id、Version 等信息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"_index"</span>:<span class="string">"accounts"</span>,</div><div class="line">  <span class="string">"_type"</span>:<span class="string">"person"</span>,</div><div class="line">  <span class="string">"_id"</span>:<span class="string">"1"</span>,</div><div class="line">  <span class="string">"_version"</span>:1,</div><div class="line">  <span class="string">"result"</span>:<span class="string">"created"</span>,</div><div class="line">  <span class="string">"_shards"</span>:&#123;<span class="string">"total"</span>:2,<span class="string">"successful"</span>:1,<span class="string">"failed"</span>:0&#125;,</div><div class="line">  <span class="string">"created"</span>:<span class="literal">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果你仔细看，会发现请求路径是/accounts/person/1，最后的1是该条记录的 Id。它不一定是数字，任意字符串（比如abc）都可以。</p>
<p>新增记录的时候，也可以不指定 Id，这时要改成 POST 请求。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ curl -X POST <span class="string">'localhost:9200/accounts/person'</span> -d <span class="string">'</span></div><div class="line"><span class="string">&#123;</span></div><div class="line"><span class="string">  "user": "李四",</span></div><div class="line"><span class="string">  "title": "工程师",</span></div><div class="line"><span class="string">  "desc": "系统管理"</span></div><div class="line"><span class="string">&#125;'</span></div></pre></td></tr></table></figure></p>
<p>上面代码中，向/accounts/person发出一个 POST 请求，添加一个记录。这时，服务器返回的 JSON 对象里面，_id字段就是一个随机字符串。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"_index"</span>:<span class="string">"accounts"</span>,</div><div class="line">  <span class="string">"_type"</span>:<span class="string">"person"</span>,</div><div class="line">  <span class="string">"_id"</span>:<span class="string">"AV3qGfrC6jMbsbXb6k1p"</span>,</div><div class="line">  <span class="string">"_version"</span>:1,</div><div class="line">  <span class="string">"result"</span>:<span class="string">"created"</span>,</div><div class="line">  <span class="string">"_shards"</span>:&#123;<span class="string">"total"</span>:2,<span class="string">"successful"</span>:1,<span class="string">"failed"</span>:0&#125;,</div><div class="line">  <span class="string">"created"</span>:<span class="literal">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>注意，如果没有先创建 Index（这个例子是accounts），直接执行上面的命令，Elastic 也不会报错，而是直接生成指定的 Index。所以，打字的时候要小心，不要写错 Index 的名称。</p>
<h6 id="5-2-查看记录"><a href="#5-2-查看记录" class="headerlink" title="5.2 查看记录"></a>5.2 查看记录</h6><p>向/Index/Type/Id发出 GET 请求，就可以查看这条记录。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ curl <span class="string">'localhost:9200/accounts/person/1?pretty=true'</span></div></pre></td></tr></table></figure></p>
<p>上面代码请求查看/accounts/person/1这条记录，URL 的参数pretty=true表示以易读的格式返回。</p>
<p>返回的数据中，found字段表示查询成功，_source字段返回原始记录。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"_index"</span> : <span class="string">"accounts"</span>,</div><div class="line">  <span class="string">"_type"</span> : <span class="string">"person"</span>,</div><div class="line">  <span class="string">"_id"</span> : <span class="string">"1"</span>,</div><div class="line">  <span class="string">"_version"</span> : 1,</div><div class="line">  <span class="string">"found"</span> : <span class="literal">true</span>,</div><div class="line">  <span class="string">"_source"</span> : &#123;</div><div class="line">    <span class="string">"user"</span> : <span class="string">"张三"</span>,</div><div class="line">    <span class="string">"title"</span> : <span class="string">"工程师"</span>,</div><div class="line">    <span class="string">"desc"</span> : <span class="string">"数据库管理"</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果 Id 不正确，就查不到数据，found字段就是false。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ curl <span class="string">'localhost:9200/weather/beijing/abc?pretty=true'</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"_index"</span> : <span class="string">"accounts"</span>,</div><div class="line">  <span class="string">"_type"</span> : <span class="string">"person"</span>,</div><div class="line">  <span class="string">"_id"</span> : <span class="string">"abc"</span>,</div><div class="line">  <span class="string">"found"</span> : <span class="literal">false</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h6 id="5-3-删除记录"><a href="#5-3-删除记录" class="headerlink" title="5.3 删除记录"></a>5.3 删除记录</h6><p>删除记录就是发出 DELETE 请求。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ curl -X DELETE <span class="string">'localhost:9200/accounts/person/1'</span></div></pre></td></tr></table></figure></p>
<p>这里先不要删除这条记录，后面还要用到。</p>
<h6 id="5-4-更新记录"><a href="#5-4-更新记录" class="headerlink" title="5.4 更新记录"></a>5.4 更新记录</h6><p>更新记录就是使用 PUT 请求，重新发送一次数据。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">$ curl -X PUT <span class="string">'localhost:9200/accounts/person/1'</span> -d <span class="string">'</span></div><div class="line"><span class="string">&#123;</span></div><div class="line"><span class="string">    "user" : "张三",</span></div><div class="line"><span class="string">    "title" : "工程师",</span></div><div class="line"><span class="string">    "desc" : "数据库管理，软件开发"</span></div><div class="line"><span class="string">&#125;'</span> </div><div class="line"></div><div class="line">&#123;</div><div class="line">  <span class="string">"_index"</span>:<span class="string">"accounts"</span>,</div><div class="line">  <span class="string">"_type"</span>:<span class="string">"person"</span>,</div><div class="line">  <span class="string">"_id"</span>:<span class="string">"1"</span>,</div><div class="line">  <span class="string">"_version"</span>:2,</div><div class="line">  <span class="string">"result"</span>:<span class="string">"updated"</span>,</div><div class="line">  <span class="string">"_shards"</span>:&#123;<span class="string">"total"</span>:2,<span class="string">"successful"</span>:1,<span class="string">"failed"</span>:0&#125;,</div><div class="line">  <span class="string">"created"</span>:<span class="literal">false</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面代码中，我们将原始数据从”数据库管理”改成”数据库管理，软件开发”。 返回结果里面，有几个字段发生了变化。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="string">"_version"</span> : 2,</div><div class="line"><span class="string">"result"</span> : <span class="string">"updated"</span>,</div><div class="line"><span class="string">"created"</span> : <span class="literal">false</span></div></pre></td></tr></table></figure>
<p>可以看到，记录的 Id 没变，但是版本（version）从1变成2，操作类型（result）从created变成updated，created字段变成false，因为这次不是新建记录。</p>
<h5 id="六、数据查询"><a href="#六、数据查询" class="headerlink" title="六、数据查询"></a>六、数据查询</h5><h6 id="6-1-返回所有记录"><a href="#6-1-返回所有记录" class="headerlink" title="6.1 返回所有记录"></a>6.1 返回所有记录</h6><p>使用 GET 方法，直接请求/Index/Type/_search，就会返回所有记录。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">$ curl <span class="string">'localhost:9200/accounts/person/_search'</span></div><div class="line"></div><div class="line">&#123;</div><div class="line">  <span class="string">"took"</span>:2,</div><div class="line">  <span class="string">"timed_out"</span>:<span class="literal">false</span>,</div><div class="line">  <span class="string">"_shards"</span>:&#123;<span class="string">"total"</span>:5,<span class="string">"successful"</span>:5,<span class="string">"failed"</span>:0&#125;,</div><div class="line">  <span class="string">"hits"</span>:&#123;</div><div class="line">    <span class="string">"total"</span>:2,</div><div class="line">    <span class="string">"max_score"</span>:1.0,</div><div class="line">    <span class="string">"hits"</span>:[</div><div class="line">      &#123;</div><div class="line">        <span class="string">"_index"</span>:<span class="string">"accounts"</span>,</div><div class="line">        <span class="string">"_type"</span>:<span class="string">"person"</span>,</div><div class="line">        <span class="string">"_id"</span>:<span class="string">"AV3qGfrC6jMbsbXb6k1p"</span>,</div><div class="line">        <span class="string">"_score"</span>:1.0,</div><div class="line">        <span class="string">"_source"</span>: &#123;</div><div class="line">          <span class="string">"user"</span>: <span class="string">"李四"</span>,</div><div class="line">          <span class="string">"title"</span>: <span class="string">"工程师"</span>,</div><div class="line">          <span class="string">"desc"</span>: <span class="string">"系统管理"</span></div><div class="line">        &#125;</div><div class="line">      &#125;,</div><div class="line">      &#123;</div><div class="line">        <span class="string">"_index"</span>:<span class="string">"accounts"</span>,</div><div class="line">        <span class="string">"_type"</span>:<span class="string">"person"</span>,</div><div class="line">        <span class="string">"_id"</span>:<span class="string">"1"</span>,</div><div class="line">        <span class="string">"_score"</span>:1.0,</div><div class="line">        <span class="string">"_source"</span>: &#123;</div><div class="line">          <span class="string">"user"</span> : <span class="string">"张三"</span>,</div><div class="line">          <span class="string">"title"</span> : <span class="string">"工程师"</span>,</div><div class="line">          <span class="string">"desc"</span> : <span class="string">"数据库管理，软件开发"</span></div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面代码中，返回结果的 took字段表示该操作的耗时（单位为毫秒），timed_out字段表示是否超时，hits字段表示命中的记录，里面子字段的含义如下。</p>
<ul>
<li><strong>total</strong>：返回记录数，本例是2条。</li>
<li><strong>max_score</strong>：最高的匹配程度，本例是1.0。</li>
<li><strong>hits</strong>：返回的记录组成的数组。<br>返回的记录中，每条记录都有一个_score字段，表示匹配的程序，默认是按照这个字段降序排列。</li>
</ul>
<h6 id="6-2-全文搜索"><a href="#6-2-全文搜索" class="headerlink" title="6.2 全文搜索"></a>6.2 全文搜索</h6><p>Elastic 的查询非常特别，使用自己的查询语法，要求 GET 请求带有数据体。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ curl <span class="string">'localhost:9200/accounts/person/_search'</span>  -d <span class="string">'</span></div><div class="line"><span class="string">&#123;</span></div><div class="line"><span class="string">  "query" : &#123; "match" : &#123; "desc" : "软件" &#125;&#125;</span></div><div class="line"><span class="string">&#125;'</span></div></pre></td></tr></table></figure>
<p>上面代码使用 Match 查询，指定的匹配条件是desc字段里面包含”软件”这个词。返回结果如下。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="string">"took"</span>:3,</div><div class="line">  <span class="string">"timed_out"</span>:<span class="literal">false</span>,</div><div class="line">  <span class="string">"_shards"</span>:&#123;<span class="string">"total"</span>:5,<span class="string">"successful"</span>:5,<span class="string">"failed"</span>:0&#125;,</div><div class="line">  <span class="string">"hits"</span>:&#123;</div><div class="line">    <span class="string">"total"</span>:1,</div><div class="line">    <span class="string">"max_score"</span>:0.28582606,</div><div class="line">    <span class="string">"hits"</span>:[</div><div class="line">      &#123;</div><div class="line">        <span class="string">"_index"</span>:<span class="string">"accounts"</span>,</div><div class="line">        <span class="string">"_type"</span>:<span class="string">"person"</span>,</div><div class="line">        <span class="string">"_id"</span>:<span class="string">"1"</span>,</div><div class="line">        <span class="string">"_score"</span>:0.28582606,</div><div class="line">        <span class="string">"_source"</span>: &#123;</div><div class="line">          <span class="string">"user"</span> : <span class="string">"张三"</span>,</div><div class="line">          <span class="string">"title"</span> : <span class="string">"工程师"</span>,</div><div class="line">          <span class="string">"desc"</span> : <span class="string">"数据库管理，软件开发"</span></div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Elastic 默认一次返回10条结果，可以通过size字段改变这个设置。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ curl <span class="string">'localhost:9200/accounts/person/_search'</span>  -d <span class="string">'</span></div><div class="line"><span class="string">&#123;</span></div><div class="line"><span class="string">  "query" : &#123; "match" : &#123; "desc" : "管理" &#125;&#125;,</span></div><div class="line"><span class="string">  "size": 1</span></div><div class="line"><span class="string">&#125;'</span></div></pre></td></tr></table></figure>
<p>上面代码指定，每次只返回一条结果。</p>
<p>还可以通过from字段，指定位移。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ curl <span class="string">'localhost:9200/accounts/person/_search'</span>  -d <span class="string">'</span></div><div class="line"><span class="string">&#123;</span></div><div class="line"><span class="string">  "query" : &#123; "match" : &#123; "desc" : "管理" &#125;&#125;,</span></div><div class="line"><span class="string">  "from": 1,</span></div><div class="line"><span class="string">  "size": 1</span></div><div class="line"><span class="string">&#125;'</span></div></pre></td></tr></table></figure>
<p>上面代码指定，从位置1开始（默认是从位置0开始），只返回一条结果。</p>
<h6 id="6-3-逻辑运算"><a href="#6-3-逻辑运算" class="headerlink" title="6.3 逻辑运算"></a>6.3 逻辑运算</h6><p>如果有多个搜索关键字， Elastic 认为它们是or关系。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ curl <span class="string">'localhost:9200/accounts/person/_search'</span>  -d <span class="string">'</span></div><div class="line"><span class="string">&#123;</span></div><div class="line"><span class="string">  "query" : &#123; "match" : &#123; "desc" : "软件 系统" &#125;&#125;</span></div><div class="line"><span class="string">&#125;'</span></div></pre></td></tr></table></figure>
<p>上面代码搜索的是软件 or 系统。</p>
<p>如果要执行多个关键词的and搜索，必须使用布尔查询。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ curl <span class="string">'localhost:9200/accounts/person/_search'</span>  -d <span class="string">'</span></div><div class="line"><span class="string">&#123;</span></div><div class="line"><span class="string">  "query": &#123;</span></div><div class="line"><span class="string">    "bool": &#123;</span></div><div class="line"><span class="string">      "must": [</span></div><div class="line"><span class="string">        &#123; "match": &#123; "desc": "软件" &#125; &#125;,</span></div><div class="line"><span class="string">        &#123; "match": &#123; "desc": "系统" &#125; &#125;</span></div><div class="line"><span class="string">      ]</span></div><div class="line"><span class="string">    &#125;</span></div><div class="line"><span class="string">  &#125;</span></div><div class="line"><span class="string">&#125;'</span></div></pre></td></tr></table></figure></p>
<h5 id="七、参考链接"><a href="#七、参考链接" class="headerlink" title="七、参考链接"></a>七、参考链接</h5><p>ElasticSearch 官方手册 (<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/getting-started.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/reference/current/getting-started.html</a>)<br>A Practical Introduction to Elasticsearch (<a href="https://www.elastic.co/blog/a-practical-introduction-to-elasticsearch" target="_blank" rel="external">https://www.elastic.co/blog/a-practical-introduction-to-elasticsearch</a>)</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-11-12</span><i class="fa fa-tag"></i><a href="/tags/java/" title="java" class="tag">java </a><a href="/tags/开源/" title="开源" class="tag">开源 </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,http://yoursite.com/2017/11/12/java4/,aliea个人博客,全文搜索引擎 Elasticsearch 基础教程,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a role="navigation" href="/2017/10/26/nginx3/" title="Nginx 的基本功能介绍" class="btn">下一篇</a></li></ul></div><a id="comments"></a><div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div><script src="https://img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"></script><script>var cloudTieConfig = { url: document.location.href, sourceId: '2017/11/12/java4/', productKey: 'mraliea', target: 'cloud-tie-wrapper' };var yunManualLoad = true;Tie.loader("aHR0cHM6Ly9hcGkuZ2VudGllLjE2My5jb20vcGMvbGl2ZXNjcmlwdC5odG1s", true);
</script></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>